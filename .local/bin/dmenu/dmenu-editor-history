#!/usr/bin/env bash

# TODO: replace $HOME with ~ in dmenu

# DMENU-EDITOR-HISTORY
# --------------------

# Bash script that provides an editor-indepentend selectable history list for
# opened files, via dmenu. See --help for usage.

# CONFIGURATION -----------------------------------------------------------------

cmd_editor=(subl)
cmd_dmenu=(fzfmenu "--prompt='Hist > '")

cmd_find=(find "$HOME")
txt_find='--- SEARCH ---'

# Indicators for special file types
indc_dir='[DIR]' # directories
indc_link='[LNK]' # symbolic links

# -------------------------------------------------------------------------------

# Include hidden files when looping over directories using * glob
shopt -s dotglob

err() {
    printf "ERROR: $1!\n" 1>&2
    exit 1
}

# File to store history in
if [[ -d $XDG_CACHE_HOME ]]; then
    hist="$XDG_CACHE_HOME/dmenu-editor-history"
else
    hist="$HOME/.dmenu-editor-history"
fi
[[ -f $hist ]] || touch "$hist"

temp='/tmp/dmenu-editor-history-tmp'

entry() {
    # New history entry, directories get turned into multiple entries

    # Arguments:
    # $1 = absolute path to a file

    printf '%s\n' "$1" > "$temp"
    len=1

    # If a directory also add the files inside because that's what I like
    if [[ -d $1 ]]; then
        for f in "$1"/*; do
            if [[ -e $f ]]; then
                printf '%s\n' "$f"
                (( len++ ))
            fi >> "$temp"
        done
    fi

    # Adding previous part of history without duplicates of new entries
    local IFS=$'\n'
    dupcount=0
    while read; do
        if [[ $dupcount -lt $len ]]; then
            for ent in $(< $temp); do
                if [[ $REPLY == $ent ]]; then
                    (( dupcount++ ))
                    continue 2
                fi
            done
        fi
        printf '%s\n' "$REPLY"
    done < "$hist" >> "$temp"

    mv "$temp" "$hist"
}

rm_non_exist() {
    # Remove non-existant files from history

    while read; do
        [[ -e "$REPLY" ]] && printf "$REPLY\n"
    done < "$hist" > "$temp"

    mv "$temp" "$hist"
}

## Cmd flags
case "$1" in
    '')
        # Pipe file into dmenu with indicators
        filename=$(printf '%s\n%s' "$txt_find" "$(
            while read; do
                if [[ -d $REPLY ]]; then
                    printf "$indc_dir $REPLY\n"
                elif [[ -h $REPLY ]]; then
                    printf "$indc_link $REPLY\n"
                else
                    printf "$REPLY\n"
                fi
            done < "$hist"   
        )" | "${cmd_dmenu[@]}" )

        [[ -z $filename ]] && err 'Empty selection'

        if [[ $filename == $txt_find ]]; then
            filename=$(${cmd_find[@]} | "${cmd_dmenu[@]}")
        else
            # Remove potential indicators
            filename=${filename#"$indc_dir "}
            filename=${filename#"$indc_link "}

            # If the file doesn't exist clean history and error out
            if ! [[ -e $filename ]]; then
                rm_non_exist
                err "$filename does not exist"
            fi
        fi

        entry "$filename"

        "${cmd_editor[@]}" "$filename" ;;

    --open|-o)
        # Absolute path to specified file
        case "$2" in
            '')
                "${cmd_editor[@]}"
                exit ;;
            .)
                filename="$PWD" ;;
            ..)
                cwd="${PWD##*/}"
                filename="${PWD%/$cwd}" ;;
            *)
                filename="$PWD/${2##*/}" ;;
        esac

        entry "$filename"

        "${cmd_editor[@]}" "$filename" ;;

    --purge|-p)
        read -p "Delete $hist? [y/n]: " del
        case "$del" in
            y|Y|yes|Yes|YES) rm -v "$hist" ;;
        esac ;;

    --clean|-c)
        rm_non_exist ;;

    --help|-h)
        read  -d '' helptext <<- 'EOF'
			Usage (long options):

			1) Open a new file (or directory) from cmd-line:
			$ dmenu-editor-history --open example.txt
			(intented to be run via a shell alias)

			2) Open a previously opened file or search for a new one from dmenu:
			$ dmenu-editor-history
			(intented to be run via a custom hotkey)

			Clear history:
			$ dmenu-editor-history --purge

			Remove all files from history that does not exist:
			$ dmenu-editor-history --clean
			(this also runs if a non-existent file is selected from dmenu)

			Print out this help text:
			$ dmenu-editor-history --help
		EOF
        printf "$helptext\n" ;;

    *)
        err 'Invalid option(s), see --help for information about usage' ;;
esac
