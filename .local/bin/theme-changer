#!/usr/bin/bash

# set system color scheme

# usage:
# ------
# $ theme-changer nord

# files:
# ------
# available themes located in $dir/themes (scripts that define color variables)
# current theme located in $dir/theme (created by this script)

# programs are fed colors in one of two ways:
# -------------------------------------------
# 1) for programs/scripts that can read these shell variables:
# - import $dir/theme and use the variables in some way in their config script
#   - tip: use an eviroment variable = $dir/theme
#     - now themes are easily imported with: . "$THEME"
#     - improves importing in multiple places
# 2) for programs that cannot read shell variables:
# - specify the path to the config file in $unwilling_files (on a new line)
# - add a comment to the config file above every line containing a hex color
#   you want to change
#   - on the form: colorize FG_ALT
#     - color names are the same as the variables in the theme file
# - if the program needs to be reloaded for colors to take effect
#   add the command to do so to reload_programs()

unwilling_files="
$HOME/.config/alacritty/alacritty.yml
$XRESOURCES
"
reload_programs() {
    xrdb "$XRESOURCES"
    xdotool key Super_L+F5
    restart-statusbar
}

dir="$HOME/.local/share/bedsi"

# replacing theme file with new theme
replace_theme() {
    color_theme="$dir/themes/$1"
    if [[ -f $color_theme ]]; then
        printf "# $1\n" > "$dir/theme"
        cat "$color_theme" >> "$dir/theme"
    else
        printf "ERROR: no valid theme given\n" && exit 1
    fi
}

# changing colors for config files that can't import shell variables
colorize_unwilling() {
    comment_regex='\scolorize\s[A-Z]\+\(_\)\?\([A-Z]\+\)\?$' # colorize FG_ALT
    hex_regex="#[A-Fa-f0-9]{6}" # #EBB062

    . "$THEME"
    for file in "$@"; do
        if ! [[ -f $file ]]; then
            printf "ERROR: no such file: $file\n"
        fi

        while read -r line ; do
            selcol="${line##* }"
            selcol_hex="$(eval echo \$$selcol)"
            next_line=$(( "${line%:*}" + 1 ))

            if [[ $selcol_hex =~ $hex_regex ]]; then
                sed -r -i ""$next_line"s/$hex_regex/$selcol_hex/" "$file"
            else
                printf "ERROR: color wrongly specified in file: $file\n"
            fi

        done < <(grep -on "$comment_regex" "$file")
    done
}

replace_theme "$1"
colorize_unwilling $unwilling_files # don't quote to allow iteration
reload_programs
