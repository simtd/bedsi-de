#!/usr/bin/bash

# set system color scheme

# usage:
#   $ theme-changer nord

# available themes are located in $dir/themes
# current theme is located in $dir/theme (created by this script)

# programs vary with how they are fed colors
# for programs and scripts that can read shell variables:
#   - import $dir/theme and use the variables directly
#   - use an eviroment variable so its easy to import in multiple files
#   - e.g. . "$THEME"
# for programs that cannot read shell variables:
#   - specify the path to the config file in $unwilling_files
#   - add comments to the config file, above every line containing a hex color
#       - on the form: colorize FG_ALT
#           - color names are the same as the variables in the theme file
#   - if the program needs to be reloaded add the command to reload_programs()

### SETUP:

dir="$HOME/.local/share/bedsi"

unwilling_files="
$HOME/.config/alacritty/alacritty.yml
$XRESOURCES
"
### FUNCTIONS:

# replacing the colors in the theme file
replace_color_theme() {
    color_theme="$dir/themes/$1"
    if [[ -f $color_theme ]]; then
        printf "# $1\n" > "$dir/theme"
        cat "$color_theme" >> "$dir/theme"
    else
        printf "ERROR: no valid theme given\n" && exit 1
    fi
}

# changing colors for config files that can't import environment variables
colorize_unwilling() {
    comment_regex='\scolorize\s[A-Z]\+\(_\)\?\([A-Z]\+\)\?$' # colorize FG_ALT
    hex_regex="#[A-Fa-f0-9]{6}" # #EBB062

    . "$THEME"
    for file in "$@"; do
        if ! [[ -f $file ]]; then
            printf "ERROR: no such file: $file\n"
        fi

        while read -r line ; do
            selcol="${line##* }"
            selcol_hex="$(eval echo \$$selcol)"
            next_line=$(( "${line%:*}" + 1 ))

            if [[ $selcol_hex =~ $hex_regex ]]; then
                sed -r -i ""$next_line"s/$hex_regex/$selcol_hex/" "$file"
            else
                printf "ERROR: color wrongly specified in file: $file\n"
            fi

        done < <(grep -on "$comment_regex" "$file")
    done
}

reload_programs() {
    xrdb "$XRESOURCES"
    xdotool key Super_L+F5
    restart-statusbar
}

### RUNNING:

replace_color_theme "$1"
colorize_unwilling $unwilling_files
reload_programs
