#!/bin/sh

# ROOT NAME STATUS
# ----------------

# POSIX statusbar script for window managers that use "xsetroot -name"

# Usage:
# * run the script: $ rnstatus start/stop/restart &
# * update modules that are intended for hotkeys: $ rnstatus volume/backlight

# Dependencies:
# * xsetroot
# * pkill, pgrep
# * light (read backlight level)
# * pactl (read audio information)
# * date

# Code structure:
# * rnstatus: user interaction, start/stop and update certain modules etc.
# * rn-modules: functions that provide actual status text
# * rn-stream: in backround, handles data stream, updates modules on timer

dir="$HOME/.local/bin/statusbar"
pipe='/tmp/rnstatus-fifo'

. "$dir/rn-modules"

err() {
	printf "ERROR: $1!\n" 1>&2
	exit 1
}

case "$1" in
    volume)
        vol_module > "$pipe" ;;
    backlight)
        . "$dir/rn-modules"
        bl_module > "$pipe" ;;
    *)
        [ -p "$pipe" ] || mkfifo "$pipe"

        start_stream() {
            pgrep -x 'rn-stream' 1> /dev/null 2>&1 && err 'already running' 

    		"$dir/rn-stream" "$dir" "$pipe" &
            vol_module > "$pipe" &
            bl_module > "$pipe" &
        }

        stop_stream() {
            pkill --exact 'rn-stream'
        }
        
        case "$1" in
            stop)
                stop_stream ;;
            start)
                start_stream ;;
            restart)
                stop_stream
                start_stream ;;
        	*)
				err 'invalid argument(s)' ;;
        esac ;;
esac